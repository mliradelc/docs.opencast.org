<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../../img/favicon.ico">
  <title>Capture Agent - Opencast - Developer Guide</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <link href="../../../css/font-awesome.min.css" rel="stylesheet">
  <link href="../../../css/style-guide.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Capture Agent";
    var mkdocs_page_input_path = "modules/capture-agent/capture-agent.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../.." class="icon icon-home"> Opencast - Developer Guide</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Development Process</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../installation/source-linux/">Installation</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../development-process/">Development</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../reviewing-and-merging/">Reviewing, Merging and Declining Pull Requests</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../release-manager/">Release Manager</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../qa-coordinator/">QA Coordinator</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../security/">Security Issues</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../code-style/">Code Style</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../documentation/">Documentation</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Decision Making</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../decision-making/">Overview</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../decision-making/lazy-consensus/">Lazy Consensus</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../decision-making/consensus-building/">Consensus Building</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../decision-making/voting/">Voting</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Development Environment</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../development-environment/">Overview</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../development-environment-docker/">With Docker</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../../committer/">Committers</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../../license/">Licenses and Legal Matters</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../../governance/">Governance</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../../localization/">Localization</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../../packaging/">Packaging</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../../proposal-log/">Proposal Log</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../../asset-manager/">Asset Manager</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../../scheduler/">Scheduler</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Modules</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../">Overview</a>
                </li>
                <li class="">
                    
    <span class="caption-text">Administrative user Interface</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../admin-ui/development/">Development</a>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">Style Guide</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../admin-ui/style/">Overview</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../admin-ui/style/color-palette/">Color Palette</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../admin-ui/style/typeface/">Typeface</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../admin-ui/style/view-structure/">View Structure</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../admin-ui/style/spacing/">Logo</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../admin-ui/style/navigation/">Navigation</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../admin-ui/style/modals/">Modals</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../admin-ui/style/forms/">Forms</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../admin-ui/style/icons/">Icons</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../admin-ui/style/buttons/">Buttons</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../admin-ui/style/dropdowns/">Dropdowns</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../admin-ui/style/alerts-indicators/">Alerts and Indicators</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../admin-ui/style/references/">References</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class=" current">
                    
    <span class="caption-text">Capture Agent</span>
    <ul class="subnav">
                <li class="toctree-l3 current">
                    
    <a class="current" href="./">Capture Agent</a>
    <ul class="subnav">
            
    <li class="toctree-l4"><a href="#introduction">Introduction</a></li>
    
        <ul>
        
            <li><a class="toctree-l5" href="#basic-rules">Basic Rules</a></li>
        
            <li><a class="toctree-l5" href="#quick-overview">Quick Overview</a></li>
        
            <li><a class="toctree-l5" href="#action-details">Action Details</a></li>
        
            <li><a class="toctree-l5" href="#agent-state-and-configuration">Agent State And Configuration</a></li>
        
            <li><a class="toctree-l5" href="#further-reading">Further Reading</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../testcases/">Test Cases</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Player</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../player/architecture/">Architecture</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../player/core.reference/">Core Reference</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../player/events/">Events</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../player/storage/">Storage</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../player/plugin.development/">Plugin Development</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../player/testing/">Testing</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../../stream-security/">Stream Security</a>
                </li>
                <li class="">
                    
    <a class="" href="../../oaipmh/">OAI-PMH</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Infrastructure</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../infrastructure/">Overview</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../infrastructure/notes/">Notes</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../infrastructure/maven-repository/">Maven Repository</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">External API</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../api/">Introduction</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../api/usage/">Usage</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../api/authentication/">Authentication</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../api/authorization/">Authorization</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../api/base-api/">Base API</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../api/agents-api/">Agents API</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../api/events-api/">Events API</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../api/series-api/">Series API</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../api/groups-api/">Groups API</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../api/security-api/">Security API</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../api/workflow-api/">Workflow API</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../api/types/">Data Types</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../api/glossary/">Glossary</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../..">Opencast - Developer Guide</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../..">Docs</a> &raquo;</li>
    
      
        
          <li>Capture Agent &raquo;</li>
        
      
        
          <li>Modules &raquo;</li>
        
      
    
    <li>Capture Agent</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/opencast/opencast/edit/develop/docs/guides/developer/docs/modules/capture-agent/capture-agent.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="introduction">Introduction</h1>
<p>This guide describes the communication protocol between Opencast and any Capture Agent.  For the sake of simplicity, the
following variables are used throughout this guide:</p>
<ul>
<li><code>$HOST</code> is your core's base URL</li>
<li><code>$AGENT_NAME</code> is the agent's name</li>
<li><code>$RECORDING_ID</code> is the recording's ID</li>
<li><code>$SERIES_ID</code> is the UUID of the series</li>
<li><code>$CUTOFF</code> is a Unix timestamp of the furthest point in time you want scheduling data for</li>
</ul>
<h2 id="basic-rules">Basic Rules</h2>
<ul>
<li>The core <em>MUST NOT</em> attempt to connect to the agent, communication is always happening from  agent to core</li>
<li>The agent <em>MUST</em> get the endpoint location from the service registry</li>
<li>The agent <em>MUST</em> try to send its recording states to the core on a regular basis during recordings</li>
<li>The agent <em>SHOULD</em> send its state to the core on a semi regular basis</li>
<li>The agent <em>MAY</em> send its capabilities to the core on a semi regular basis</li>
<li>The agent <em>MUST</em> attempt to update its calendaring data regularly</li>
<li>The agent <em>MUST</em> must capture with all available inputs if no inputs are selected</li>
<li>The agent <em>MAY</em> tell the core the address of its web interface</li>
</ul>
<h2 id="quick-overview">Quick Overview</h2>
<p>The following list gives a short overview over the communication between agent and core. Remember, it is up to the agent
to initiate the connections. Also note that ideally some operations may run in parallel.</p>
<ul>
<li>request rest endpoints</li>
<li>register agent and set status</li>
<li>set the agents capabilities</li>
<li>repeat:<ul>
<li>while no recording<ul>
<li>get schedule/calendar</li>
</ul>
</li>
<li>set agent and recording state</li>
<li>start recording</li>
<li>set agent and recording state</li>
<li>update ingest endpoints</li>
<li>ingest recording</li>
<li>set agent and recording state</li>
</ul>
</li>
</ul>
<h2 id="action-details">Action Details</h2>
<p>This is a detailed description of the steps described in the quick overview section.</p>
<p>For details about the REST endpoints, please <em>always</em> consult the Opencast REST documentation which can be found in the
top-right corner of the administrative user interface of each running Opencast instance. Note that most endpoints can
handle both JSON and XML although throughout this guide, for all examples, only JSON is used.</p>
<h3 id="get-endpoint-locations-from-service-registry">Get Endpoint Locations From Service Registry</h3>
<p>First, you need to get the locations of the REST endpoints to talk to. These information can be retrieved from the
central service registry. It is likely that Opencast is running as a distributed system which means you cannot expect
all endpoints on a single host.</p>
<p>Three endpoint locations need to be requested:</p>
<ul>
<li>The capture-admin endpoint to register the agent and set status and configuration: <code>org.opencastproject.capture.admin</code></li>
<li>The scheduler endpoint to get the current schedule for the agent from: <code>org.opencastproject.scheduler</code></li>
<li>The ingest endpoint to upload the recordings to once they are done: <code>org.opencastproject.ingest</code></li>
</ul>
<p>To ask for an endpoint you would send an HTTP GET request to</p>
<pre><code>${HOST}/services/available.json?serviceType=&lt;SERVICE&gt;
</code></pre>
<p>A result would look like</p>
<pre><code>{
  "services" : {
    "service" : {
      "active" : true,
      "host" : "http://example.opencast.org:8080",
      "path" : "/capture-admin",
      ...
    }
  }
}
</code></pre>
<p>These endpoints should be requested once when starting up the capture agent. While the capture-admin and scheduler
endpoints may then be assumed to never change during the runtime of the capture agent, the ingest endpoint may change
and the data should be re-requested every time before uploading (ingesting) data to the core.</p>
<h3 id="register-the-capture-agent-and-set-current-status">Register the Capture Agent and set Current Status</h3>
<p>Once the endpoints to talk to are known, it is time to register the capture agent at the core so that scheduled events
can be added. This can be done by sending an HTTP POST request to:</p>
<pre><code>${CAPTURE-ADMIN-ENDPOINT}/agents/&lt;name&gt;
</code></pre>
<p>…including the following data fields:</p>
<pre><code>state=idle
address=http(s)://&lt;ca-web-ui&gt;
</code></pre>
<p>The name has to be a unique identifier of a single capture agent. Using the same name for several agents would mean
sharing the same schedule and status which in general should be avoided.</p>
<p>Sending this request will register the capture agent. After this, the capture agent should appear in the admin interface
and schedules can be added for this agent.</p>
<p>Setting <code>address</code> is optional. It can be used to link an administrative web
interface of a capture agent.</p>
<h3 id="setting-agent-capabilities">Setting Agent Capabilities</h3>
<p>Additional to registering, the agent may set its capabilities allowing users to select possible inputs in the user
interface of Opencast when scheduling events. The configuration may be set as XML or JSON representation of a Java
properties file and can be set via an HTTP POST request to:</p>
<pre><code>/capture-admin/agents/$AGENT_NAME/configuration
</code></pre>
<h3 id="getting-the-calendarschedule">Getting the Calendar/Schedule</h3>
<p>The calendar can be retrieved by sending an HTTP GET request to</p>
<pre><code>${SCHEDULER-ENDPOINT}/calendars?agentid=&lt;name&gt;
</code></pre>
<p>The format returned is iCal. The file contains all scheduled upcoming recordings the capture agent should handle.</p>
<p>Depending on the amount of recordings scheduled for the particular capture agent, this file may become very large. That
is why there are two way of limiting the amount of necessary data to transfer and process:</p>
<ol>
<li>
<p>Sending the optional parameter <code>cutoff</code> to limit the schedule to a particular time span in the future.</p>
<p>${SCHEDULER-ENDPOINT}/calendars?agentid=<name>&amp;cutoff=<time></p>
</li>
</ol>
<p>The value for cutoff is a Unix timestamp in milliseconds from now. Events beginning after this time will not be
   included in the returned schedule.</p>
<ol>
<li>Use the HTTP ETag and If-Not-Modified header to have Opencast only sent schedules when they have actually changed.</li>
</ol>
<h3 id="set-agent-and-recording-state">Set Agent and Recording State</h3>
<p>Setting the agent state is identical to the registration of the capture agent and done by sending an HTTP POST request
to:</p>
<pre><code>${CAPTURE-ADMIN-ENDPOINT}/agents/&lt;name&gt;
</code></pre>
<p>…including the following data fields:</p>
<pre><code>state=capturing
address=http(s)://&lt;ca-web-ui&gt;
</code></pre>
<p>Additionally, set the recording state with an HTTP POST request to</p>
<pre><code>${CAPTURE-ADMIN-ENDPOINT}/recordings/&lt;recording_id&gt;
</code></pre>
<p>…including the data field:</p>
<pre><code>state=capturing
</code></pre>
<h3 id="recording">Recording</h3>
<p>This task is device specific. Use whatever means necessary to get the recording
done.</p>
<h3 id="set-agent-and-recording-state_1">Set Agent and Recording State</h3>
<p>This step is identical to the previous status update but for the state.</p>
<p>If the recording has failed, the recording state is updated with <code>capture_error</code> while the agent's state is set back to
<code>idle</code> if the error is non-permanent and to <code>error</code> if it is permanent and block further recordings.</p>
<p>If the recording was successful, both states are set to <code>uploading</code>.</p>
<h3 id="get-ingest-endpoint-locations-from-service-registry">Get Ingest Endpoint Locations From Service Registry</h3>
<p>This step is identical to first request to the service registry expect that it is sufficient to request the location for
the service <code>org.opencastproject.ingest</code>. If this request fails, assume the old data to be valid.</p>
<h3 id="ingest-upload-recording">Ingest (Upload) Recording</h3>
<p>Use the ingest endpoint to upload the recording.</p>
<p>There are multiple different methods to ingest media. Please refer to the REST endpoint documentation for details of
these methods. The most commonly used are:</p>
<ul>
<li>Single request ingest using an HTTP POST request to<ul>
<li><code>${INGEST-ENDPOINT}/addMediaPackage</code></li>
</ul>
</li>
<li>Multi request ingest using HTTP POST requests to<ul>
<li><code>${INGEST-ENDPOINT}/createMediaPackage</code></li>
<li><code>${INGEST-ENDPOINT}/addDCCatalog</code></li>
<li><code>${INGEST-ENDPOINT}/addTrack</code></li>
<li><code>${INGEST-ENDPOINT}/ingest</code></li>
</ul>
</li>
</ul>
<p>If possible, please follow these additional rules about recording files:</p>
<ul>
<li>Recordings may be deleted if the ingest was successful.</li>
<li>Recordings should be stored in case of a failure.</li>
</ul>
<h4 id="upload-metadata">Upload Metadata</h4>
<p>The calendar (iCal) with the scheduled events retrieved in an earlier step also contains metadata catalogs as attached
files. To modify metadata, these catalogs can be modified and ingested as well. Opencast's default setting is to use
these for updating the existing metadata in the system.</p>
<p>If no metadata modifications are required (usual case), please do not modify these files and do not upload
them. In short: Ignore these attachments</p>
<p>Additional note for Opencast ≤ 3.x: Opencast only creates events in the database after ingesting the files. Scheduled
data are kept separately. That is why for these Opencast versions, all metadata files need to be ingested. Usually, that
means to take the metadata catalogs from the schedule and ingest them unmodified using for example the <code>/addDCCatalog</code>
endpoint.</p>
<h3 id="set-agent-and-recording-state_2">Set Agent and Recording State</h3>
<p>Again, this step is identical to the previous status updates except for the state.</p>
<p>If the upload has failed, the recording state is updated with <code>upload_error</code> while the agents state is set back to
<code>idle</code> if the error is non-permanent or to <code>error</code> otherwise.</p>
<p>If the upload was successful, the recording status is set to <code>upload_finished</code> while the agents state is set back to
<code>idle</code>.</p>
<h2 id="agent-state-and-configuration">Agent State And Configuration</h2>
<p>This section describes some additional aspects of the communication between capture agent and the Opencast core.</p>
<h3 id="creating-an-agent-on-the-core">Creating An Agent On The Core</h3>
<p>An agent record is created on the core the first time the agent communicates with the core. There is no special endpoint
or registration required, just send the state and the agent record will be created.</p>
<h3 id="agent-state">Agent State</h3>
<p>Additional to the required status updates outlined above, the agent should continue to send this status information on a
regular basis to allow Opencast to determine that the agent is still active. If the agent fails to do so, it may be
marked as offline in the Opencast user interface after a certain amount of time (The default is 120min).</p>
<h3 id="agent-configuration">Agent Configuration</h3>
<p>If a special configuration is required, the agent should send its configuration data in a regular interval to ensure
Opencast has the updated configuration even if the core is reset in the meantime.</p>
<p>It should also send the configuration when the agent's configuration changes to avoid conflicts between selected and
available options.</p>
<p>The format of this XML structure is the following:</p>
<pre><code class="XML">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;
&lt;!DOCTYPE properties SYSTEM &quot;http://java.sun.com/dtd/properties.dtd\&quot;&gt;
&lt;properties&gt;
  &lt;comment&gt;Capabilities for $AGENT_NAME&lt;/comment&gt;
  &lt;entry key=&quot;$KEY_NAME&quot;&gt;$VALUE&lt;/entry&gt;
  …
&lt;/properties&gt;
</code></pre>

<p>If sent as JSON, the format is a simple JSON object:</p>
<pre><code class="JSON">{
  'key':'value',
  'key2':'value2'
}
</code></pre>

<p>To specify inputs the user can select, the special key <code>capture.device.names</code> is used.  It is a comma separated list of
inputs which will be presented in the Opencast user interface.</p>
<h3 id="recording-state">Recording State</h3>
<p>If the agent is processing (recording) a previously scheduled event, it must send the recording's state to the core. It
may do this on a regular basis but at least should do this once the state of the recording changes since, for example,
the recording process has started.</p>
<p>Note that these status changes are used in the administrative user interface and failing to set a state may cause the
interface to display a warning such as “The agent may have failed to start this recording”.</p>
<p>To send the recording's state to the core, a valid state (as defined here) is sent via HTTP POST to:</p>
<pre><code>${CAPTURE-ADMIN-ENDPOINT}/recordings/&lt;recording_id&gt;
</code></pre>
<h3 id="calendaring-data">Calendaring Data</h3>
<p>Agent's are expected to understand Opencast's iCalendar implementation. They should poll the calendar endpoint in a
regular interval to update their internal schedule.</p>
<p>Agent's should use a permanent cache (e.g. disk or database) for the cached schedule to be able to handle power and/or
network failures gracefully. This also allows an agent to be used in a network-less environment, for example for mobile
recordings: Merely cache the calendar data once after which the agent is brought to its destination where it will
capture and cache the pre-scheduled recordings.</p>
<p>To retrieve the calendar for an agent an HTTP GET is performed to</p>
<pre><code>${SCHEDULER-ENDPOINT}/calendars?agentid=&lt;name&gt;
</code></pre>
<p>Note that the schedule has ETag support, which is very useful to speed up the processing of larger calendars.</p>
<h3 id="capture-agent-configuration-file">Capture Agent Configuration File</h3>
<p><em>TODO: Verify that this is still necessary with ≥ 4.0</em></p>
<p>One file attached to each scheduled event is <code>org.opencastproject.capture.agent.properties</code>. This file contains the
capture agent configuration directives (e.g. turning inputs on and off) as well as workflow directives which are
important for the ingest process without which the core may misbehave.</p>
<p>All keys in this file contain prefixes identifying the type of property. For example, workflow directives are prefixed
by <code>org.opencastproject.workflow.config</code>.  When passing the configuration directive to the core using the file  ingest
REST endpoints, the agent must usually strip this prefix from the parameter. For example,
<code>org.opencastproject.workflow.config.trimHold=true</code> should be passed as <code>trimHold=true</code>.</p>
<p>The <code>org.opencastproject.workflow.definition directive</code> is important as well, this is the workflow definition identifier
and should be passed as a parameter during the ingest operation.</p>
<p>Example configuration file:</p>
<pre><code>#Capture Agent specific data
#Tue May 22 17:34:22 CST 2012
org.opencastproject.workflow.config.trimHold=true
capture.device.names=MOCK_SCREEN,MOCK_PRESENTER,MOCK_MICROPHONE
org.opencastproject.workflow.definition=full
event.title=Test Capture
event.location=demo_capture_agent
</code></pre>
<h3 id="ingesting-media">Ingesting Media</h3>
<p>Opencast provides several different methods to ingest media, with each having some advantages and disadvantages. The
following description will give a short overview of the different methods. For more details, again, have a look at the
REST endpoint documentation of the ingest service.</p>
<h4 id="multi-request-ingest">Multi Request Ingest</h4>
<p><em>This is the recommended way to use for most capture agents. It offers the most features to use and does not require any
pre- and post-processing of ingested material.</em></p>
<p>Using this method, a number of successive HTTP calls are made during the ingestion of media. The result of a successful
call is the newly updated media package. This media package is created by one call, then amended by a number of other
calls, each adding additional elements like tracks, attachments or metadata catalohs. Finally, it is then passed to the
last endpoint to begin processing.</p>
<p>The advantage to this process is that in case of a network failure only one particular element needs to be repeated in
contrast to repeating the whole process required by all other ingest methods.</p>
<p>To begin, the agent must first generate a valid media package. This is done via an HTTP GET request to
<code>${INGEST-ENDPOINT}/createMediaPackage</code>. The resulting media package will contain the base skeleton used in later calls.
Each following call will require a media package as input and will modify and return it to be used for the next call.</p>
<p>The next step(s) vary. Essentially, each generated file for a recording must be added, one at a time, to the media
package. For this, an agent may use the following REST endpoints:</p>
<ul>
<li><code>${INGEST-ENDPOINT}/addTrack</code> to add media files (video, audio, …) used for processing and/or publication</li>
<li><code>${INGEST-ENDPOINT}/addDCCatalog</code> to add the dublin core metadata catalogs like the basic episode metadata (title, …)</li>
<li><code>${INGEST-ENDPOINT}/addCatalog</code> to add all types of metadata catalogs.  This is a more general version of
  <code>addDCCatalog</code> and is seldom necessary.</li>
<li><code>${INGEST-ENDPOINT}/addAttachment</code> to add arbitrary attachments (cover images, access control catalogs, …) to the
  media package.</li>
</ul>
<p>Finally, once you have added all files, it is time to ingest the media package and begin processing. After this, no
further files can be added.</p>
<p>To ingest a recording, an HTTP POST is sent to <code>${INGEST-SERVICE}/ingest</code>.</p>
<h4 id="single-request-ingest">Single Request Ingest</h4>
<p>The single request ingest will, as its name implies, handle the whole process as part of a single HTTP request. This
is a convenient way of adding smaller ingest since the implementation does not require to store any internal state. The
operation is atomic after all: Either it succeeds or fails.</p>
<p>The disadvantage to this is that the complexity of ingests is limited, e.g. no attachments can be added to the media
package this way, and a failure means that all files need to be re-transferred.</p>
<p>For this method, the agent posts all data to <code>${INGEST-ENDPOINT}/addMediaPackage</code>.</p>
<h4 id="zipped-media-ingest">Zipped Media Ingest</h4>
<p>In general, the use of this method is discouraged because of the additional load for packing and unpacking the material
compared to the negligible gain. For this method, the captured media, along with some metadata files is zipped and then
HTTP POSTed to the core. The core then unzips the media package and begins processing. This unzipping operation is quite
disk intensive, and the REST endpoint does not return until the unzipping is done. Thus, please beware of proxy timeouts
and additional disk utilization.</p>
<p>To ingest a zipped media package an HTTP POST is performed to <code>${INGEST-ENDPOINT}/addZippedMediaPackage</code>. The BODY of
the POST must contain the zipped media package.</p>
<h2 id="further-reading">Further Reading</h2>
<p>The communication involve several REST endpoints. Additional documentation about these can be found in the REST docs of
the specific service. The REST documentation can be found at <code>/rest_docs.html</code> in every Opencast instance to reflect
that servers unique capabilities.</p>
<p>Services involved in the communication with the capture agent are:</p>
<ul>
<li>The capture admin service used to register the capture agent and set its current status.</li>
<li>The scheduler service to get scheduled recordings for an agent.</li>
<li>The ingest service to upload recording files and start processing.</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../testcases/" class="btn btn-neutral float-right" title="Test Cases">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../../admin-ui/style/references/" class="btn btn-neutral" title="References"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/opencast/opencast/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../../admin-ui/style/references/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../testcases/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>

</body>
</html>
