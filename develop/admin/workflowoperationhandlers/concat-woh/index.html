<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Concat - Administration Guide</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <link href="../../css/extra.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Concat Workflow Operation Handler", url: "#_top", children: [
              {title: "General Mode", url: "#general-mode" },
              {title: "Same Codec Mode", url: "#same-codec-mode" },
              {title: "Usage", url: "#usage" },
              {title: "Configuration Keys", url: "#configuration-keys" },
              {title: "Example", url: "#example" },
              {title: "Encoding Profile", url: "#encoding-profile" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script>
      <script src="../../javascript/extra.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../configure-by-dcterm-woh/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../configure-by-dcterm-woh/" class="btn btn-xs btn-link">
        Configure-By-DCTerm
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../composite-woh/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../composite-woh/" class="btn btn-xs btn-link">
        Composite
      </a>
    </div>
    
  </div>

    

    <h1 id="concat-workflow-operation-handler">Concat Workflow Operation Handler</h1>
<p>The <em>concat</em> operation handler has been created to concatenate multiple video tracks into one video track.</p>
<p>For a concatenation of two video files to work, both files need to have the same format (timebase, resolution, codecs,
frame rate, etc.). This workflow operation has two modes to deal with this restriction:</p>
<ul>
<li>A <em>general</em> mode which re-encodes all input files, hence ensuring that this restriction is always met.</li>
<li>A <em>same codec</em> mode which assumes the restriction is already met and can hence concatenate the files much faster while
  also being a lossless process. But it will fail or produce a weird output if if the restrictions are not met.</li>
</ul>
<h2 id="general-mode">General Mode</h2>
<p><em>No restriction on source tracks codecs</em></p>
<p>This will re-encode the videos first to the same format (framerate/timebase/codec, etc) before concatenation.</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: G Pages: 1 -->
<p><svg width="505pt" height="207pt"
 viewBox="0.00 0.00 505.00 207.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 203)">
<title>G</title>
<g id="clust1" class="cluster">
<title>cluster_inputs</title>
<polygon fill="transparent" stroke="#d3d3d3" points="8,-8 8,-191 125,-191 125,-8 8,-8"/>
<text text-anchor="middle" x="66.5" y="-175.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">Input</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_output</title>
<polygon fill="transparent" stroke="#d3d3d3" points="235,-62 235,-137 489,-137 489,-62 235,-62"/>
<text text-anchor="middle" x="362" y="-121.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">Output</text>
</g>
<!-- outro --></p>
<p><g id="node1" class="node">
<title>outro</title>
<polygon fill="none" stroke="#000000" points="117,-160 16,-160 16,-124 117,-124 117,-160"/>
<text text-anchor="middle" x="66.5" y="-144.6" font-family="Times,serif" font-size="8.00" fill="#000000">outro</text>
<text text-anchor="middle" x="66.5" y="-135.6" font-family="Times,serif" font-size="8.00" fill="#000000">source&#45;flavor&#45;part&#45;2</text>
</g>
<!-- concat --></p>
<p><g id="node7" class="node">
<title>concat</title>
<ellipse fill="none" stroke="#000000" cx="180" cy="-88" rx="27" ry="18"/>
<text text-anchor="middle" x="180" y="-86.1" font-family="Times,serif" font-size="8.00" fill="#000000">concat</text>
</g>
<!-- outro&#45;&gt;concat --></p>
<p><g id="edge3" class="edge">
<title>outro&#45;&gt;concat</title>
<path fill="none" stroke="#000000" d="M105.8949,-123.9743C112.2931,-121.0017 118.8394,-117.9333 125,-115 133.8957,-110.7644 143.5543,-106.0592 152.2592,-101.7787"/>
<polygon fill="#000000" stroke="#000000" points="153.6587,-103.4303 158.1122,-98.8942 151.8019,-99.6629 153.6587,-103.4303"/>
</g>
<!-- intro --></p>
<p><g id="node2" class="node">
<title>intro</title>
<polygon fill="none" stroke="#000000" points="117,-106 16,-106 16,-70 117,-70 117,-106"/>
<text text-anchor="middle" x="66.5" y="-90.6" font-family="Times,serif" font-size="8.00" fill="#000000">intro</text>
<text text-anchor="middle" x="66.5" y="-81.6" font-family="Times,serif" font-size="8.00" fill="#000000">source&#45;flavor&#45;part&#45;0</text>
</g>
<!-- intro&#45;&gt;concat --></p>
<p><g id="edge4" class="edge">
<title>intro&#45;&gt;concat</title>
<path fill="none" stroke="#000000" d="M117.2745,-88C127.2495,-88 137.4734,-88 146.6952,-88"/>
<polygon fill="#000000" stroke="#000000" points="146.9041,-90.1001 152.9041,-88 146.904,-85.9001 146.9041,-90.1001"/>
</g>
<!-- presenter --></p>
<p><g id="node3" class="node">
<title>presenter</title>
<polygon fill="none" stroke="#000000" points="117,-52 16,-52 16,-16 117,-16 117,-52"/>
<text text-anchor="middle" x="66.5" y="-36.6" font-family="Times,serif" font-size="8.00" fill="#000000">presenter</text>
<text text-anchor="middle" x="66.5" y="-27.6" font-family="Times,serif" font-size="8.00" fill="#000000">source&#45;flavor&#45;part&#45;1</text>
</g>
<!-- presenter&#45;&gt;concat --></p>
<p><g id="edge5" class="edge">
<title>presenter&#45;&gt;concat</title>
<path fill="none" stroke="#000000" d="M105.8949,-52.0257C112.2931,-54.9983 118.8394,-58.0667 125,-61 133.8957,-65.2356 143.5543,-69.9408 152.2592,-74.2213"/>
<polygon fill="#000000" stroke="#000000" points="151.8019,-76.3371 158.1122,-77.1058 153.6587,-72.5697 151.8019,-76.3371"/>
</g>
<!-- o_intro --></p>
<p><g id="node4" class="node">
<title>o_intro</title>
<polygon fill="none" stroke="#000000" points="297,-106 243,-106 243,-70 297,-70 297,-106"/>
<text text-anchor="middle" x="270" y="-86.1" font-family="Times,serif" font-size="8.00" fill="#000000">intro</text>
</g>
<!-- o_presenter --></p>
<p><g id="node5" class="node">
<title>o_presenter</title>
<polygon fill="none" stroke="#000000" points="391,-106 333,-106 333,-70 391,-70 391,-106"/>
<text text-anchor="middle" x="362" y="-86.1" font-family="Times,serif" font-size="8.00" fill="#000000">presenter</text>
</g>
<!-- o_intro&#45;&gt;o_presenter --></p>
<p><g id="edge1" class="edge">
<title>o_intro&#45;&gt;o_presenter</title>
<path fill="none" stroke="#000000" d="M297.1054,-88C306.4108,-88 316.9648,-88 326.817,-88"/>
<polygon fill="#000000" stroke="#000000" points="326.8433,-90.1001 332.8432,-88 326.8432,-85.9001 326.8433,-90.1001"/>
</g>
<!-- o_outro --></p>
<p><g id="node6" class="node">
<title>o_outro</title>
<polygon fill="none" stroke="#000000" points="481,-106 427,-106 427,-70 481,-70 481,-106"/>
<text text-anchor="middle" x="454" y="-86.1" font-family="Times,serif" font-size="8.00" fill="#000000">outro</text>
</g>
<!-- o_presenter&#45;&gt;o_outro --></p>
<p><g id="edge2" class="edge">
<title>o_presenter&#45;&gt;o_outro</title>
<path fill="none" stroke="#000000" d="M391.1094,-88C400.5234,-88 411.0334,-88 420.7254,-88"/>
<polygon fill="#000000" stroke="#000000" points="420.9566,-90.1001 426.9566,-88 420.9566,-85.9001 420.9566,-90.1001"/>
</g>
<!-- concat&#45;&gt;o_intro --></p>
<p><g id="edge6" class="edge">
<title>concat&#45;&gt;o_intro</title>
<path fill="none" stroke="#000000" d="M207.003,-88C213.8783,-88 221.4246,-88 228.8315,-88"/>
<polygon fill="#000000" stroke="#000000" points="229.0027,-90.1001 235.0027,-88 229.0027,-85.9001 229.0027,-90.1001"/>
</g>
</g>
</svg></p>
<p>The internal FFmpeg command for re-encoding is using the following filters: fps, scale, pad and setdar for scaling all
videos to a similar size including letterboxing, aevalsrc for creating silent audio streams and of course the concat for
the actual concatenation step.</p>
<p>This requires an output-resolution and an optional output-framerate for the pre-concatenation encode.</p>
<p>The automatically generated FFmpeg filter for this process does look like this:</p>
<pre><code>-filter_complex '
  [0:v]fps=fps=25.0,scale=iw*min(640/iw\,480/ih):ih*min(640/iw\,480/ih),pad=640:480:(ow-iw)/2:(oh-ih)/2,setdar=4:3[b];
  [1:v]fps=fps=25.0,scale=iw*min(640/iw\,480/ih):ih*min(640/iw\,480/ih),pad=640:480:(ow-iw)/2:(oh-ih)/2,setdar=4:3[c];
  [2:v]fps=fps=25.0,scale=iw*min(640/iw\,480/ih):ih*min(640/iw\,480/ih),pad=640:480:(ow-iw)/2:(oh-ih)/2,setdar=4:3[d];
  aevalsrc=0::d=1[silent];
  [b][0:a][c][silent][d][2:a]concat=n=3:v=1:a=1[v][a]' -map '[v]' -map '[a]'
</code></pre>
<h2 id="same-codec-mode">Same Codec Mode</h2>
<p><em>Requires the source tracks having the same format (same timebase/resolution/encoding, etc.)</em></p>
<p>If the <code>same-codec</code> option is specified to use this mode, the sources files can be arranged into one container
losslessly without re-encoding first.  This is often the case if the tracks came from the same camera/recorder for
example.</p>
<p>This mode uses <a href="https://www.ffmpeg.org/ffmpeg-formats.html#concat-1">FFmpeg's concat demuxer</a>, which puts all the video
content into a single container without any re-encoding. The encoding profile then operates on the source in this
container. If <code>-c copy</code> is used in the encoding profile, the complete concatenation is lossless.</p>
<p>The FFmpeg command for this is is:</p>
<pre><code>-f concat -i videolist.txt
</code></pre>
<p>…where <code>videolist.txt</code> contains a line in the form <code>file &lt;path to video&gt;</code> for each source track.</p>
<h2 id="usage">Usage</h2>
<p>This operation is quite similar to the compose operation. The only difference is that the input properties are not only
limited to one <code>source-flavor</code> and <code>source-tag</code>. The operation supports multiple flavor and tags as input. To add
multiple sources, add different keys with the prefix <code>source-flavor-</code>/<code>source-tag-</code> and an incremental number starting
with 0. For example:</p>
<ul>
<li><code>source-flavor-part-0</code></li>
<li><code>source-flavor-part-1</code></li>
<li><code>source-flavor-part-..</code></li>
</ul>
<p>Alternatively, using the <code>source-flavor-numbered-files</code> option, the operation supports an undetermined number of
ordered input files.</p>
<p>This is useful when the number of input files cannot be known in advance, such as chunked output files from some
camera/recorders, and the names are ordered by number or timestamps and to be sorted lexicographically.</p>
<p>For example, the configuration could be <code>source-flavor-numbered-files: multipart/part+source</code> and the ordered input
files:</p>
<pre><code>video-201711201020.mp4
video-201711201030.mp4
video-201711201040.mp4
</code></pre>
<p><em>Note that both methods of defining input files are mutually exclusive.</em></p>
<h2 id="configuration-keys">Configuration Keys</h2>
<table>
<thead>
<tr>
<th>Key</th>
<th>Required</th>
<th>Description</th>
<th>Default</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>source-flavor-part-X</code></td>
<td>false</td>
<td>An iterative list of part/flavor to use as input track.</td>
<td><code>NULL</code></td>
<td><code>presenter/trimmed</code></td>
</tr>
<tr>
<td><code>source-tag-part-X</code></td>
<td>false</td>
<td>An iterative list of part/tag to use as input track.</td>
<td><code>NULL</code></td>
<td><code>source-to-concate</code></td>
</tr>
<tr>
<td><code>source-flavor-part-X-mandatory</code></td>
<td>false</td>
<td>Define the flavor part-X as optional for concatenation.</td>
<td><code>false</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td><code>source-tag-part-X-mandatory</code></td>
<td>false</td>
<td>Define the tag part-X as optional for concatenation.</td>
<td><code>false</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td><code>encoding-profile</code></td>
<td>true</td>
<td>Encoding profile to use for the concatenation.</td>
<td><code>NULL</code></td>
<td><code>concat</code></td>
</tr>
<tr>
<td><code>target-flavor</code></td>
<td>true</td>
<td>Flavor(s) to add to the output track.</td>
<td><code>NULL</code></td>
<td><code>presenter/concat</code></td>
</tr>
<tr>
<td><code>target-tags</code></td>
<td>false</td>
<td>Tag(s) to add to the output track</td>
<td><code>NULL</code></td>
<td><code>engage-download</code></td>
</tr>
<tr>
<td><code>output-resolution</code></td>
<td>true</td>
<td>Output resolution in width, height or a source part</td>
<td><code>NULL</code></td>
<td><code>1900x1080</code>, <code>part-1</code></td>
</tr>
<tr>
<td><code>output-framerate</code></td>
<td>false</td>
<td>Output frame rate in frames per second or a source part</td>
<td><code>-1.0</code></td>
<td><code>25</code>, <code>23.976</code>, <code>part-1</code></td>
</tr>
<tr>
<td><code>source-flavor-numbered-files</code></td>
<td>false</td>
<td>Files of this flavor are ordered lexicographically to use as input track.</td>
<td><code>NULL</code></td>
<td><code>multipart/sections</code></td>
</tr>
<tr>
<td><code>same-codec</code></td>
<td>false</td>
<td>All source files have identical formats.</td>
<td><code>false</code></td>
<td><code>true</code></td>
</tr>
</tbody>
</table>
<h2 id="example">Example</h2>
<p>Example of a concat operation in a workflow definition.</p>
<pre><code class="language-xml">&lt;!-- Add intro and outro part to the presenter track --&gt;
&lt;operation
  id=&quot;concat&quot;
  fail-on-error=&quot;true&quot;
  exception-handler-workflow=&quot;error&quot;
  description=&quot;Concatenate the presenter track and the intro/outro videos.&quot;&gt;
  &lt;configurations&gt;
    &lt;configuration key=&quot;source-flavor-part-0&quot;&gt;intro/source&lt;/configuration&gt;
    &lt;configuration key=&quot;source-flavor-part-1&quot;&gt;presenter/trimmed&lt;/configuration&gt;
    &lt;configuration key=&quot;source-flavor-part-1-mandatory&quot;&gt;true&lt;/configuration&gt;
    &lt;configuration key=&quot;source-flavor-part-2&quot;&gt;outro/source&lt;/configuration&gt;
    &lt;configuration key=&quot;target-flavor&quot;&gt;presenter/concat&lt;/configuration&gt;
    &lt;configuration key=&quot;target-tags&quot;&gt;engage-download,engage-streaming&lt;/configuration&gt;
    &lt;configuration key=&quot;encoding-profile&quot;&gt;concat&lt;/configuration&gt;
    &lt;configuration key=&quot;output-resolution&quot;&gt;1920x1080&lt;/configuration&gt;
    &lt;configuration key=&quot;output-framerate&quot;&gt;part-1&lt;/configuration&gt;
  &lt;/configurations&gt;
&lt;/operation&gt;
</code></pre>
<p>Example of a lossless concat operation for videos with identical formats in a workflow definition.</p>
<pre><code class="language-xml">&lt;!-- Concatenate chunked video from camera --&gt;
&lt;operation
  id=&quot;concat&quot;
  fail-on-error=&quot;true&quot;
  exception-handler-workflow=&quot;error&quot;
  description=&quot;Concatenate the generated videos.&quot;&gt;
  &lt;configurations&gt;
    &lt;configuration key=&quot;source-flavor-numbered-files&quot;&gt;multipart/chunkedsource&lt;/configuration&gt;
    &lt;configuration key=&quot;target-flavor&quot;&gt;presenter/concat&lt;/configuration&gt;
    &lt;configuration key=&quot;target-tags&quot;&gt;engage-download,engage-streaming&lt;/configuration&gt;
    &lt;!-- do not encode before concatenation --&gt;
    &lt;configuration key=&quot;same-codec&quot;&gt;true&lt;/configuration&gt;
    &lt;configuration key=&quot;encoding-profile&quot;&gt;concat-samecodec&lt;/configuration&gt;
  &lt;/configurations&gt;
&lt;/operation&gt;
</code></pre>
<h2 id="encoding-profile">Encoding Profile</h2>
<p>The encoding profile command must contain the #{concatCommand} parameter which will set all input and possibly filter
commands required for this operation:</p>
<pre><code>profile.concat.ffmpeg.command = #{concatCommand} \
  … #{out.dir}/#{out.name}#{out.suffix}
</code></pre>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../configure-by-dcterm-woh/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../configure-by-dcterm-woh/" class="btn btn-xs btn-link">
        Configure-By-DCTerm
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../composite-woh/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../composite-woh/" class="btn btn-xs btn-link">
        Composite
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
      <p>
        <a href="https://github.com/opencast/opencast/edit/develop/docs/guides/admin/docs/workflowoperationhandlers/concat-woh.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>